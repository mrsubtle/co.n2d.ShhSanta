/*! co.n2d.ShhSanta 25-10-2015 */
var modals={mdl_item_create:{el:"#mdl_item_create",hide:function(){this.remE(),$("group.modalContainer").one("webkittransitionend transitionend",function(){$(modals.mdl_item_create.el).addClass("hidden"),setTimeout(function(){$("#frm_item_create")[0].reset(),$(modals.mdl_item_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").addClass("hidden")},1)}),$("group.modalContainer").addClass("modalOff"),$(".app").toggleClass("tilt")},show:function(){$(".app").toggleClass("tilt"),modals.mdl_item_create.remE(),modals.mdl_item_create.addE(),modals.mdl_item_create.render(),$(modals.mdl_item_create.el+" content").scrollTop(0),$(modals.mdl_item_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").addClass("hidden")},addE:function(){$(modals.mdl_item_create.el+" #frm_item_create").on("submit",function(e){e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_cancel").hammer().on("tap",function(e){modals.mdl_item_create.hide(),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_save").hammer().on("tap",function(e){modals.mdl_item_create.setData(),e.preventDefault()}),$(modals.mdl_item_create.el+" #txt_upc").on("blur",function(e){var upc=$(modals.mdl_item_create.el+" #txt_upc").val();if(""!=upc||null!=upc)try{util.getDataUPC(upc,function(d){$(modals.mdl_item_create.el+" #lbl_barcodeStatus").html("...item found!"),d.images.length>=1&&util.convertImgToBase64(d.images[0],function(base64string){var v={uri:base64string},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")}),$(modals.mdl_item_create.el+" #txt_name").val(d.name)},function(e){var obj=$(modals.mdl_item_create.el+" #lbl_barcodeStatus"),objMsg=obj.html();obj.html("...item info not found. :("),setTimeout(function(){obj.html(objMsg)},3e3)})}catch(e){console.log(e)}}),$(modals.mdl_item_create.el+" #btn_scanBarcode").hammer().on("tap",function(e){var lblO=$(modals.mdl_item_create.el+" #frm_item_create #lbl_barcodeStatus"),tmpLbl=lblO.html();lblO.html($("#tpl_loading").html()),cordova.plugins.barcodeScanner.scan(function(result){if(0==result.cancelled){lblO.html("...successful scan..."),$("#frm_item_create #txt_upc").val(result.text);var upc=result.text;(""!=upc||null!=upc)&&util.getDataUPC(upc,function(d){d.images.length>=1&&util.convertImgToBase64(d.images[0],function(base64string){var v={uri:base64string},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")}),$(modals.mdl_item_create.el+" #txt_name").val(d.name)},function(e){console.log(e)})}else lblO.html(tmpLbl);console.log(result)},function(error){lblO.html(tmpLbl),app.e("Oops! Scan seems to have failed, but don't worry - we'll fix it. Eventiually."),console.log(error)}),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_takeItemPhoto").hammer().on("tap",function(e){navigator.camera.getPicture(function(imgData){var v={uri:"data:image/png;base64,"+imgData},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")},function(error){app.e("Can't take a picture.  I don't know why.  Do you?")},{quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!0,targetWidth:1024,targetHeight:1024,encodingType:Camera.EncodingType.PNG,cameraDirection:Camera.Direction.BACK}),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_selectItemPhoto").hammer().on("tap",function(e){navigator.camera.getPicture(function(imgData){var v={uri:"data:image/png;base64,"+imgData},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")},function(error){app.e("Umm... This is embarassing. I can't open the gallery.  I don't know why.  Do you?")},{quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,allowEdit:!0,targetWidth:1024,targetHeight:1024,encodingType:Camera.EncodingType.PNG}),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").hammer().on("tap",function(e){$(modals.mdl_item_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").addClass("hidden"),e.preventDefault()})},remE:function(){$(modals.mdl_item_create.el+" #frm_item_create").off("submit"),$(modals.mdl_item_create.el+" #btn_cancel").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_save").hammer().off("tap"),$(modals.mdl_item_create.el+" #txt_upc").off("blur"),$(modals.mdl_item_create.el+" #btn_scanBarcode").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_takeItemPhoto").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_selectItemPhoto").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").hammer().off("tap")},render:function(){$(modals.mdl_item_create.el).removeClass("hidden"),$("group.modalContainer").removeClass("modalOff")},setData:function(){var Item=Parse.Object.extend("Item"),newItem=new Item;if(newItem.set("owner",Parse.User.current()),newItem.set("name",$(modals.mdl_item_create.el+" #txt_name").val()),newItem.set("description",$(modals.mdl_item_create.el+" #txt_description").val()),newItem.set("upc",parseInt($(modals.mdl_item_create.el+" #txt_upc").val())),newItem.set("rating",parseInt($(modals.mdl_item_create.el+" #txt_rating").val())),newItem.set("lastSeenAt",$(modals.mdl_item_create.el+" #txt_lastSeenAt").val()),newItem.set("estPrice",parseInt($(modals.mdl_item_create.el+" #txt_estPrice").val())),0!=$("#mdl_item_create #item_create_photoContainer img").length){var t=$("#mdl_item_create #item_create_photoContainer img").attr("src"),base64data=t.slice("data:image/png;base64,".length),image=new Parse.File("item.png",{base64:base64data});newItem.set("photo",image)}newItem.save(null,{success:function(newItem){user.wishList.push(newItem),pages.wishList.init(),modals.mdl_item_create.hide()},error:function(newItem,error){app.e("Couldn't save that item.  We'll look into it ASAP!"),app.l(JSON.stringify(error,null,2),2)}})}}},pages={login:{init:function(){pages.login.remE(),pages.login.addE()},addE:function(){$("#frm_Login").on("submit",function(e){pages.login.doLogin(),e.preventDefault()}),$("#btn_signup").hammer().on("tap",function(e){app.showScreen($("section#signup"),!0),e.preventDefault()})},remE:function(){$("#frm_Login").off("submit"),$("#btn_signup").hammer().off("tap")},doLogin:function(){$("#lbl_loginError").removeClass("bad"),$("#lbl_loginError").removeClass("good"),$("#lbl_loginError").html("working..."),$("#lbl_loginError").removeClass("clear"),Parse.User.logIn($("#frm_Login #txt_username").val(),$("#frm_Login #txt_password").val(),{success:function(u){$("#lbl_loginError").addClass("good"),$("#lbl_loginError").html("success!"),$("input").blur(),setTimeout(function(){$("#lbl_loginError").addClass("clear")},5e3),app.signin()},error:function(u,error){$("#lbl_loginError").addClass("bad"),101==error.code&&($("#lbl_loginError").html("nope!"),setTimeout(function(){$("#lbl_loginError").addClass("clear")},5e3)),console.error(error)}})}},signup:{init:function(){pages.signup.remE(),pages.signup.addE()},addE:function(){$("#frm_signup").on("submit",function(e){pages.signup.doSignUp(),e.preventDefault()}),$("#frm_signup #txt_username").on("focus",function(){(""==$(this).val()||null==$(this).val())&&($(this).val(util.generateElfName()),$(this).select())}),$("#frm_signup #txt_passwordConfirm").on("keyup",function(){$(this).val()==$("#frm_signup #txt_password").val()?($(this).removeClass("bad"),$(this).addClass("good")):($(this).removeClass("good"),$(this).addClass("bad")),0==$("#frm_signup .bad").length?$("#frm_signup #btn_submit-signup").prop("disabled",!1):$("#frm_signup #btn_submit-signup").prop("disabled",!0)}),$("#frm_signup #btn_cancel").hammer().on("tap",function(){app.showScreen($("section#login"))})},remE:function(){$("form#frm_signup").off("submit"),$("#frm_signup #txt_username").off("focus"),$("#frm_signup #txt_username").hammer().off("tap"),$("#frm_signup #txt_passwordConfirm").off("keyup"),$("section#signup #btn_cancel").hammer().off("tap")},doSignUp:function(){user.parse=new Parse.User,user.parse.set("username",$("#frm_signup #txt_username").val()),user.parse.set("password",$("#frm_signup #txt_password").val()),user.parse.set("email",$("#frm_signup #txt_email").val()),user.parse.set("firstName",$("#frm_signup #txt_firstName").val()),user.parse.set("lastName",$("#frm_signup #txt_lastName").val()),user.parse.set("displayName",$("#frm_signup #txt_firstName").val()+" "+$("#frm_signup #txt_lastName").val().substr(0,1)+"."),user.parse.signUp(null,{success:function(user){app.signin()},error:function(user,error){$("#lbl_signupError").html(error.message),$("#lbl_signupError").removeClass("clear"),app.l(JSON.stringify(error,null,2),2),setTimeout(function(){$("#lbl_signupError").addClass("clear")},5e3)}})}},start:{init:function(callback){pages.start.getData(pages.start.render,!1),callback&&callback()},addE:function(){$("#santaList li").hammer().on("tap",function(e){app.meta.currentPersonObjectID=$(this).attr("id"),pages.personWishList.getData(app.showScreen($("section#personWishList"),!1),function(){app.l("Failed to get person data",2)})})},remE:function(){$("#santaList li .front").hammer().off("tap")},render:function(callback){user.santaList.length>0&&($(".screen#start #santaList").html(""),$.each(user.santaList,function(i,v){var template=_.template($("#tpl_start_listItem").html());$(".screen#start #santaList").append(template(v))}),pages.start.remE(),pages.start.addE(),app.remE(),app.addE()),callback&&callback()},getData:function(successCallback,failCallack){var url="js/santaList.json";$.getJSON(url,function(d){}).done(function(d){user.santaList=_.sortBy(d,function(o){return-o.eventAt}),successCallback&&successCallback()}).fail(function(d){app.l(d,2),failCallack&&failCallack()}).always(function(){})}},wishList:{init:function(){pages.wishList.getData()},addE:function(){$("nav#top #btn_addItem").hammer().on("tap",function(){modals.mdl_item_create.show()})},remE:function(){$("nav#top #btn_addItem").hammer().off("tap")},render:function(callback){$("#wishList.screen #wishList").html(""),$.each(user.wishList,function(i,v){var t=_.template($("#tpl_wishList_listItem").html()),d={objectId:v.get("objectId"),name:v.get("name"),description:v.get("description"),photoURL:v.get("photo").url()};$("#wishList.screen #wishList").append(t(d)),pages.wishList.remE(),app.remE(),app.addE(),pages.wishList.addE()}),callback&&callback()},getData:function(successCallback,errorCallback){$("#wishList.screen #wishList").html("");var loaderTpl=_.template($("#tpl_loading").html());$("#wishList.screen #wishList").append(loaderTpl(null));var Item=Parse.Object.extend("Item"),wishListQuery=new Parse.Query(Item);wishListQuery.descending("rating"),wishListQuery.equalTo("owner",Parse.User.current()),wishListQuery.include("owner"),wishListQuery.find({success:function(results){console.log(results),user.wishList=results,successCallback&&successCallback()},error:function(error){app.e("Darn it! I couldn't find your Wish List.  Gimmea sec, and try again."),app.l(JSON.stringify(error,null,2),2),errorCallback&&errorCallback()}}).then(function(){pages.wishList.render()})}},events:{init:function(){},addE:function(){},remE:function(){}},eventCreate:{init:function(){},addE:function(){},remE:function(){},render:function(){},setData:function(){}},eventDetail:{init:function(){},addE:function(){},remE:function(){},render:function(){},getData:function(){}},itemCreate:{init:function(){},addE:function(){},remE:function(){},render:function(){},setData:function(){}},itemDetail:{init:function(){},addE:function(){},remE:function(){},render:function(){},getData:function(){}},personWishList:{init:function(){},addE:function(){},remE:function(){},render:function(){},getData:function(successCallback,failCallack){var url="js/person-"+app.meta.currentPersonObjectID+".json";$.getJSON(url,function(d){}).done(function(d){console.log(d),successCallback&&successCallback()}).fail(function(d){app.l(d,2),failCallack&&failCallack()}).always(function(){})}},settings:{init:function(){pages.settings.remE(),pages.settings.addE(),pages.settings.getData()},addE:function(){$("section#settings #btn_logout").hammer().on("tap",function(e){app.exit(),e.preventDefault()})},remE:function(){$("section#settings #btn_logout").hammer().off("tap")},render:function(){$("nav#top .right").html(user.parse.get("firstName")+"'s Settings");var av=null;user.parse.get("avatar")&&(av=user.parse.get("avatar").url());var upData={objectId:user.parse.get("objectId"),avatar:av,firstName:user.parse.get("firstName"),lastName:user.parse.get("lastName"),elfName:user.parse.get("username")},template=_.template($("#tpl_userProfile").html());$("section#settings #userProfile").html(""),$("section#settings #userProfile").append(template(upData))},getData:function(successCallback,failCallack){Parse.User.current().fetch({success:function(user){pages.settings.render(),successCallback&&successCallback()},error:function(user,error){app.e("Ah nuts!\nWe couldn't get your profile data!\nWe're on it though, try again later. :)"),app.l(JSON.stringify(error,null,2),2),failCallack&&failCallack()}})}}},app={meta:{currentPersonObjectID:""},d:{s3:{key:"SEM3B276C4B7FC81D24558D608D8121DF6AA",secret:"YjQ1NTMzNDRmMTNmMzQyNzgyMjhlOWQ1ODVjMThlZGM",productURI:"https://api.semantics3.com/v1/products?q=",productTestURI:"https://api.semantics3.com/test/v1/products?q="},outpan:{key:"e4df75113dd952806a676e683515c618"},s:[],l:[]},init:function(){localStorage.sessionLog="",localStorage.logs&&(app.d.l=JSON.parse(localStorage.logs)),shake=new Shake({threshold:15}),shake.start(),$(window).on("shake",function(){var newElfName=util.generateElfName();navigator.notification.confirm("(tee hee)",function(buttonIndex){switch(buttonIndex){case 1:console.log(newElfName);break;case 2:cordova.plugins.clipboard.copy(newElfName)}},newElfName,["lol, ok cloze","copy"])}),app.bindEvents(),user.parse=Parse.User.current(),user.parse?app.signin():app.showScreen($("section.screen#login"),!0)},exit:function(){Parse.User.logOut(),user.parse=Parse.User.current(),localStorage.setItem("user",JSON.stringify(user)),location.reload(!0)},signin:function(){user.parse=Parse.User.current(),localStorage.setItem("user",JSON.stringify(user)),app.showScreen($("section#start"),!0)},showScreen:function(s,animateBoolean,callBack){switch(animateBoolean?$("section.screen:not(.hidden)").each(function(){$(this).addClass("animate300").addClass("clear"),$(this).one("webkitTransitionEnd",function(){$(this).addClass("hidden"),$(this).removeClass("animate300").removeClass("clear")})}):$("section.screen").each(function(){$(this).addClass("hidden").addClass("clear")}),s.data("title")?$("nav#top .right").html(s.data("title")):$("nav#top .right").html("Shh Santa!"),$("nav#top .left i").addClass("clear"),$("nav#top .left i").addClass("hidden"),s.data("nav-icon")&&($("nav#top .left i[id="+s.data("nav-icon")+"]").removeClass("hidden"),setTimeout(function(){$("nav#top .left i[id="+s.data("nav-icon")+"]").removeClass("clear")},10)),$("nav#tab .item img.off").each(function(i){$(this).removeClass("hidden")}),$("nav#tab .item img.on").each(function(i){$(this).addClass("hidden")}),$("nav#tab .item[data-screen="+s.attr("id")+"] img.off").addClass("hidden"),$("nav#tab .item[data-screen="+s.attr("id")+"] img.on").removeClass("hidden"),animateBoolean?(s.addClass("clear").removeClass("hidden").addClass("animate300"),setTimeout(function(){s.removeClass("clear")},10),s.one("webkitTransitionEnd",function(){s.removeClass("animate300")})):s.removeClass("clear").removeClass("hidden"),s.attr("id")){case"login":pages.login.init();break;case"start":pages.start.init();break;case"signup":pages.signup.init();break;case"settings":pages.settings.init();break;case"wishList":pages.wishList.init();break;default:console.log(s.attr("id"))}1==s.data("nav")&&$("nav#top").removeClass("hidden"),1==s.data("tabbar")&&$("nav#tab").removeClass("hidden"),callBack&&callBack()},s:function(message,type){var d=new Date;type||(type=0);var log={date:d.getTime(),msg:message,type:type};2==type?console.error(log.date+"("+log.type+"): "+log.msg):1==type?console.warn(log.date+"("+log.type+"): "+log.msg):console.log(log.date+"("+log.type+"): "+log.msg),app.d.s.push(log),localStorage.sessionLog=JSON.stringify(app.d.s)},l:function(message,type){var d=new Date;type||(type=0);var log={date:d.getTime(),msg:message,type:type};2==type?console.error(log.date+"("+log.type+"): "+log.msg):1==type?console.warn(log.date+"("+log.type+"): "+log.msg):console.log(log.date+"("+log.type+"): "+log.msg),app.d.l.push(log),localStorage.logs=JSON.stringify(app.d.l)},e:function(message){"undefined"==typeof message&&(message="Something went wrong - but we've got the best Elves on the job."),navigator.notification.alert(message,function(){},"What a lump 'o coal","Nuts.")},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1),app.remE(),app.addE()},addE:function(){$(".touchable").on("touchstart mousedown",function(){$(".touchable").removeClass("touched"),$(this).addClass("touched")}),$(".touchable").on("touchend touchcancel mouseup",function(){$(".touchable").removeClass("touched")}),$(".touchable").hammer().on("tap",function(e){e.preventDefault(),$(this).addClass()}),$(".shakeable").on("touchstart mousedown",function(){$(".shakeable").removeClass("shake"),$(this).addClass("shake")}),$(".shakeable").on("touchend touchcancel mouseup",function(){$(".shakeable").removeClass("shake")}),$("nav#tab .item").hammer().on("tap",function(e){var s=$("section.screen#"+$(this).data("screen"));app.showScreen(s,!1)})},remE:function(){$(".touchable").off("touchstart mousedown"),$(".touchable").off("touchend touchcancel mouseup"),$(".touchable").hammer().off("tap"),$(".shakeable").off("touchstart mousedown"),$(".shakeable").off("touchend touchcancel mouseup"),$("nav#tab .item").hammer().off("tap")},onDeviceReady:function(){app.s("deviceready")}},user={parse:null,santaList:[],eventList:[],wishList:[]},util={random:function(min,max){return Math.floor(Math.random()*(max-min))+min},elf:{firstNameSyllables:["mon","fay","shi","zag","blarg","resh","izen","chi","under","little","hill","donk","larp","jazz","ears","hat","tarp","zion","ity","mirf","mop","tree","pine","magic","mana","tree","sugar","candy","sock","gift","buddy","derp","woo","ear","pointy","kris","grumpy","happy","silly","dopy","wiley","funny","fuzzy"],lastNameSyllables:["malo","zak","aboo","wonk","derp","wood","brush","thrup","green","brown","seed","nut","son","kilt","shoe","ion","hole","butch","esis","ou","ash","wind","weak","magi","large","pro","bush","shrub","hill","top","bottom","thistle","leaf","mountain","cliff","isle","islay","pond","candy","cane","pit","hole","story","book","tool","cheer","funny","furry","fuzzy","silly"]},generateElfName:function(){for(var fn="",numSyllablesFN=util.random(2,4),i=0;numSyllablesFN>i;i++)fn+=util.elf.firstNameSyllables[util.random(0,util.elf.firstNameSyllables.length)];var fnFirstLetter=fn.substr(0,1).toUpperCase();fn=fn.slice(1),fn=fnFirstLetter+fn;for(var ln="",numSyllablesLN=util.random(1,4),i=0;numSyllablesLN>i;i++)ln+=util.elf.lastNameSyllables[util.random(0,util.elf.lastNameSyllables.length)];var lnFirstLetter=ln.substr(0,1).toUpperCase();return ln=ln.slice(1),ln=lnFirstLetter+ln,fn+" "+ln},shake:null,getDataUPCold:function(upc){var oauth=OAuth({consumer:{"public":app.d.s3.key,secret:app.d.s3.secret},signature_method:"PLAINTEXT"}),request_data={url:app.d.s3.productTestURI,method:"GET",data:{upc:upc,fields:["name"]}};({"public":app.d.s3.key,secret:app.d.s3.secret});$.ajax({url:request_data.url,type:request_data.method,data:oauth.authorize(request_data)}).done(function(data){console.log("S3:\n"+data)})},getDataUPC:function(upc,successCallback,errorCallback){var url="http://www.outpan.com/api/get-product.php?barcode="+upc+"&apikey="+app.d.outpan.key;$.getJSON(url,null).done(function(d){d.error?errorCallback&&errorCallback(d):successCallback&&successCallback(d)}).fail(function(e){errorCallback&&errorCallback(e)}).always(function(){console.log("product lookup done")})},convertImgToBase64:function(url,callback,outputFormat){var canvas=document.createElement("CANVAS"),ctx=canvas.getContext("2d"),img=new Image;img.crossOrigin="Anonymous",img.onload=function(){var dataURL;canvas.height=img.height,canvas.width=img.width,ctx.drawImage(img,0,0),dataURL=canvas.toDataURL(outputFormat),callback.call(this,dataURL),canvas=null},img.src=url}};