/*! co.n2d.ShhSanta 01-11-2015 */
Date.prototype.addHours=function(h){return this.setHours(this.getHours()+h),this},Date.prototype.subHours=function(h){return this.setHours(this.getHours()-h),this},Date.prototype.addMinutes=function(m){return this.setMinutes(this.getMinutes()+m),this},Date.prototype.subMinutes=function(m){return this.setMinutes(this.getMinutes()-m),this},Date.prototype.addSeconds=function(s){return this.setSeconds(this.getSeconds()+s),this},Date.prototype.subSeconds=function(s){return this.setSeconds(this.getSeconds()-s),this},Date.prototype.toUTC=function(){return moment&&this.setMinutes(this.getMinutes()+moment().utcOffset()),this};var modals={mdl_item_create:{el:"#mdl_item_create",hide:function(){this.remE(),$("group.modalContainer").one("webkittransitionend transitionend",function(){$(modals.mdl_item_create.el).addClass("hidden"),setTimeout(function(){$("#frm_item_create")[0].reset(),$(modals.mdl_item_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").addClass("hidden")},1)}),$("group.modalContainer").addClass("modalOff"),$(".app").toggleClass("tilt")},show:function(){$(".app").toggleClass("tilt"),modals.mdl_item_create.remE().done(modals.mdl_item_create.addE().done(modals.mdl_item_create.render))},addE:function(){return $.Deferred(function(a){$(modals.mdl_item_create.el+" #frm_item_create").on("submit",function(e){e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_cancel").hammer().on("tap",function(e){modals.mdl_item_create.hide(),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_save").hammer().on("tap",function(e){modals.mdl_item_create.setData(),e.preventDefault()}),$(modals.mdl_item_create.el+" #txt_upc").on("blur",function(e){var upc=$(modals.mdl_item_create.el+" #txt_upc").val();if(""!=upc||null!=upc)try{util.getDataUPC(upc,function(d){$(modals.mdl_item_create.el+" #lbl_barcodeStatus").html("...item found!"),d.images.length>=1&&util.convertImgToBase64(d.images[0],function(base64string){var v={uri:base64string},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")}),$(modals.mdl_item_create.el+" #txt_name").val(d.name)},function(e){var obj=$(modals.mdl_item_create.el+" #lbl_barcodeStatus"),objMsg=obj.html();obj.html("...item info not found. :("),setTimeout(function(){obj.html(objMsg)},3e3)})}catch(e){console.log(e)}}),$(modals.mdl_item_create.el+" #btn_scanBarcode").hammer().on("tap",function(e){var lblO=$(modals.mdl_item_create.el+" #frm_item_create #lbl_barcodeStatus"),tmpLbl=lblO.html();lblO.html($("#tpl_loading").html()),cordova.plugins.barcodeScanner.scan(function(result){if(0==result.cancelled){lblO.html("...successful scan..."),$("#frm_item_create #txt_upc").val(result.text);var upc=result.text;(""!=upc||null!=upc)&&util.getDataUPC(upc,function(d){d.images.length>=1&&util.convertImgToBase64(d.images[0],function(base64string){var v={uri:base64string},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")}),$(modals.mdl_item_create.el+" #txt_name").val(d.name)},function(e){console.log(e)})}else lblO.html(tmpLbl);console.log(result)},function(error){lblO.html(tmpLbl),app.e("Oops! Scan seems to have failed, but don't worry - we'll fix it. Eventiually."),console.log(error)}),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_takeItemPhoto").hammer().on("tap",function(e){navigator.camera.getPicture(function(imgData){var v={uri:"data:image/png;base64,"+imgData},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")},function(error){app.e("Can't take a picture.  I don't know why.  Do you?")},{quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!0,targetWidth:1024,targetHeight:1024,encodingType:Camera.EncodingType.PNG,cameraDirection:Camera.Direction.BACK}),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_selectItemPhoto").hammer().on("tap",function(e){navigator.camera.getPicture(function(imgData){var v={uri:"data:image/png;base64,"+imgData},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_item_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").removeClass("hidden")},function(error){app.e("Umm... This is embarassing. I can't open the gallery.  I don't know why.  Do you?")},{quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,allowEdit:!0,targetWidth:1024,targetHeight:1024,encodingType:Camera.EncodingType.PNG}),e.preventDefault()}),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").hammer().on("tap",function(e){$(modals.mdl_item_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").addClass("hidden"),e.preventDefault()}),a.resolve()}).promise()},remE:function(){return $.Deferred(function(r){$(modals.mdl_item_create.el+" #frm_item_create").off("submit"),$(modals.mdl_item_create.el+" #btn_cancel").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_save").hammer().off("tap"),$(modals.mdl_item_create.el+" #txt_upc").off("blur"),$(modals.mdl_item_create.el+" #btn_scanBarcode").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_takeItemPhoto").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_selectItemPhoto").hammer().off("tap"),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").hammer().off("tap"),r.resolve()}).promise()},render:function(){$(modals.mdl_item_create.el+" content").scrollTop(0),$(modals.mdl_item_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_item_create.el+" #btn_deleteItemPhoto").addClass("hidden"),$(modals.mdl_item_create.el).removeClass("hidden"),$("group.modalContainer").removeClass("modalOff")},setData:function(){var Item=Parse.Object.extend("Item"),newItem=new Item;if(newItem.set("owner",Parse.User.current()),newItem.set("name",$(modals.mdl_item_create.el+" #txt_name").val()),newItem.set("description",$(modals.mdl_item_create.el+" #txt_description").val()),newItem.set("upc",parseInt($(modals.mdl_item_create.el+" #txt_upc").val())),newItem.set("rating",parseInt($(modals.mdl_item_create.el+" #txt_rating").val())),newItem.set("lastSeenAt",$(modals.mdl_item_create.el+" #txt_lastSeenAt").val()),newItem.set("estPrice",parseInt($(modals.mdl_item_create.el+" #txt_estPrice").val())),0!=$("#mdl_item_create #item_create_photoContainer img").length){var t=$("#mdl_item_create #item_create_photoContainer img").attr("src"),base64data=t.slice("data:image/png;base64,".length),image=new Parse.File("item.png",{base64:base64data});newItem.set("photo",image)}newItem.save(null,{success:function(newItem){user.wishList.push(newItem),pages.wishList.init(),modals.mdl_item_create.hide()},error:function(newItem,error){app.e("Couldn't save that item.  We'll look into it ASAP!"),app.l(JSON.stringify(error,null,2),2)}})}},mdl_event_create:{el:"#mdl_event_create",hide:function(){this.remE(),$("group.modalContainer").one("webkittransitionend transitionend",function(){$(modals.mdl_event_create.el).addClass("hidden"),setTimeout(function(){$("#frm_item_create")[0].reset(),$(modals.mdl_event_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").addClass("hidden")},1)}),$("group.modalContainer").addClass("modalOff"),$(".app").toggleClass("tilt")},show:function(){$(".app").toggleClass("tilt"),modals.mdl_event_create.remE().then(modals.mdl_event_create.addE().done(function(){modals.mdl_event_create.render(),$(modals.mdl_event_create.el+" content").scrollTop(0)}))},addE:function(){return $.Deferred(function(a){$(modals.mdl_event_create.el+" #frm_event_create").on("submit",function(e){modals.mdl_event_create.setData(),e.preventDefault()}),$(modals.mdl_event_create.el+" #btn_cancel").hammer().on("tap",function(e){modals.mdl_event_create.hide(),e.preventDefault()}),$(modals.mdl_event_create.el+" #btn_save").hammer().on("tap",function(e){modals.mdl_event_create.setData(),e.preventDefault()}),$(modals.mdl_event_create.el+" #txt_upc").on("blur",function(e){var upc=$(modals.mdl_event_create.el+" #txt_upc").val();if(""!=upc||null!=upc)try{util.getDataUPC(upc,function(d){$(modals.mdl_event_create.el+" #lbl_barcodeStatus").html("...item found!"),d.images.length>=1&&util.convertImgToBase64(d.images[0],function(base64string){var v={uri:base64string},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_event_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").removeClass("hidden")}),$(modals.mdl_event_create.el+" #txt_name").val(d.name)},function(e){var obj=$(modals.mdl_event_create.el+" #lbl_barcodeStatus"),objMsg=obj.html();obj.html("...item info not found. :("),setTimeout(function(){obj.html(objMsg)},3e3)})}catch(e){console.log(e)}}),$(modals.mdl_event_create.el+" #btn_scanBarcode").hammer().on("tap",function(e){var lblO=$(modals.mdl_event_create.el+" #frm_item_create #lbl_barcodeStatus"),tmpLbl=lblO.html();lblO.html($("#tpl_loading").html()),cordova.plugins.barcodeScanner.scan(function(result){if(0==result.cancelled){lblO.html("...successful scan..."),$("#frm_item_create #txt_upc").val(result.text);var upc=result.text;(""!=upc||null!=upc)&&util.getDataUPC(upc,function(d){d.images.length>=1&&util.convertImgToBase64(d.images[0],function(base64string){var v={uri:base64string},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_event_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").removeClass("hidden")}),$(modals.mdl_event_create.el+" #txt_name").val(d.name)},function(e){console.log(e)})}else lblO.html(tmpLbl);console.log(result)},function(error){lblO.html(tmpLbl),app.e("Oops! Scan seems to have failed, but don't worry - we'll fix it. Eventiually."),console.log(error)}),e.preventDefault()}),$(modals.mdl_event_create.el+" #btn_takeItemPhoto").hammer().on("tap",function(e){navigator.camera.getPicture(function(imgData){var v={uri:"data:image/png;base64,"+imgData},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_event_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").removeClass("hidden")},function(error){app.e("Can't take a picture.  I don't know why.  Do you?")},{quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:!0,targetWidth:1024,targetHeight:1024,encodingType:Camera.EncodingType.PNG,cameraDirection:Camera.Direction.BACK}),e.preventDefault()}),$(modals.mdl_event_create.el+" #btn_selectItemPhoto").hammer().on("tap",function(e){navigator.camera.getPicture(function(imgData){var v={uri:"data:image/png;base64,"+imgData},tpl=_.template($("#tpl_item_create_photo").html());$(modals.mdl_event_create.el+" #item_create_photoContainer").html(tpl(v)),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").removeClass("hidden")},function(error){app.e("Umm... This is embarassing. I can't open the gallery.  I don't know why.  Do you?")},{quality:80,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,allowEdit:!0,targetWidth:1024,targetHeight:1024,encodingType:Camera.EncodingType.PNG}),e.preventDefault()}),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").hammer().on("tap",function(e){$(modals.mdl_event_create.el+" #item_create_photoContainer").html(""),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").addClass("hidden"),e.preventDefault()}),a.resolve()}).promise()},remE:function(){return $.Deferred(function(r){$(modals.mdl_event_create.el+" #frm_item_create").off("submit"),$(modals.mdl_event_create.el+" #btn_cancel").hammer().off("tap"),$(modals.mdl_event_create.el+" #btn_save").hammer().off("tap"),$(modals.mdl_event_create.el+" #txt_upc").off("blur"),$(modals.mdl_event_create.el+" #btn_scanBarcode").hammer().off("tap"),$(modals.mdl_event_create.el+" #btn_takeItemPhoto").hammer().off("tap"),$(modals.mdl_event_create.el+" #btn_selectItemPhoto").hammer().off("tap"),$(modals.mdl_event_create.el+" #btn_deleteItemPhoto").hammer().off("tap"),r.resolve()}).promise()},render:function(){var currentDate=new Date,timezoneOffset=60*currentDate.getTimezoneOffset()*1e3,localDate=new Date(currentDate.getTime()-timezoneOffset),localDateISOString=localDate.toISOString().replace("Z","");$(modals.mdl_event_create.el+" #txt_date").val(localDateISOString),$(modals.mdl_event_create.el).removeClass("hidden"),$("group.modalContainer").removeClass("modalOff")},setData:function(){var eAt=moment($(modals.mdl_event_create.el+" #txt_date").val()).local().valueOf(),Event=Parse.Object.extend("Event"),newEvent=new Event;newEvent.set("createdBy",Parse.User.current()),newEvent.set("title",$(modals.mdl_event_create.el+" #txt_title").val()),newEvent.set("description",$(modals.mdl_event_create.el+" #txt_description").val()),newEvent.set("eventAt",new Date(eAt)),newEvent.set("spendLimit",parseInt($(modals.mdl_event_create.el+" #txt_limit").val())),newEvent.set("isLocked",!1),newEvent.save(null,{success:function(newEvent){user.getEvents(!0).done(function(){pages.events.render(),modals.mdl_event_create.hide()})},error:function(newEvent,error){app.e("Couldn't save the event!  We'll look into it ASAP!"),app.l(JSON.stringify(error,null,2),2)}})}}},pages={login:{init:function(){pages.login.remE(),pages.login.addE()},addE:function(){$("#frm_Login").on("submit",function(e){pages.login.doLogin(),e.preventDefault()}),$("#btn_signup").hammer().on("tap",function(e){app.showScreen($("section#signup"),!0),e.preventDefault()})},remE:function(){$("#frm_Login").off("submit"),$("#btn_signup").hammer().off("tap")},doLogin:function(){$("#lbl_loginError").removeClass("bad"),$("#lbl_loginError").removeClass("good"),$("#lbl_loginError").html("working..."),$("#lbl_loginError").removeClass("clear"),Parse.User.logIn($("#frm_Login #txt_username").val(),$("#frm_Login #txt_password").val(),{success:function(u){$("#lbl_loginError").addClass("good"),$("#lbl_loginError").html("success!"),$("input").blur(),setTimeout(function(){$("#lbl_loginError").addClass("clear")},5e3),app.signin()},error:function(u,error){$("#lbl_loginError").addClass("bad"),101==error.code&&($("#lbl_loginError").html("bad email or password!"),setTimeout(function(){$("#lbl_loginError").addClass("clear")},5e3)),console.error(error)}})}},signup:{init:function(){pages.signup.remE(),pages.signup.addE()},addE:function(){$("#frm_signup").on("submit",function(e){pages.signup.doSignUp(),e.preventDefault()}),$("#frm_signup #txt_username").on("focus",function(){(""==$(this).val()||null==$(this).val())&&($(this).val(util.generateElfName()),$(this).select())}),$("#frm_signup #txt_passwordConfirm").on("keyup",function(){$(this).val()==$("#frm_signup #txt_password").val()?($(this).removeClass("bad"),$(this).addClass("good")):($(this).removeClass("good"),$(this).addClass("bad")),0==$("#frm_signup .bad").length?$("#frm_signup #btn_submit-signup").prop("disabled",!1):$("#frm_signup #btn_submit-signup").prop("disabled",!0)}),$("#frm_signup #btn_cancel").hammer().on("tap",function(){app.showScreen($("section#login"))})},remE:function(){$("form#frm_signup").off("submit"),$("#frm_signup #txt_username").off("focus"),$("#frm_signup #txt_username").hammer().off("tap"),$("#frm_signup #txt_passwordConfirm").off("keyup"),$("section#signup #btn_cancel").hammer().off("tap")},doSignUp:function(){user.parse=new Parse.User,user.parse.set("username",$("#frm_signup #txt_email").val()),user.parse.set("elfName",$("#frm_signup #txt_elfName").val()),user.parse.set("password",$("#frm_signup #txt_password").val()),user.parse.set("email",$("#frm_signup #txt_email").val()),user.parse.set("firstName",$("#frm_signup #txt_firstName").val()),user.parse.set("lastName",$("#frm_signup #txt_lastName").val()),user.parse.set("displayName",$("#frm_signup #txt_firstName").val()+" "+$("#frm_signup #txt_lastName").val().substr(0,1)+"."),user.parse.signUp(null,{success:function(user){app.signin()},error:function(user,error){$("#lbl_signupError").html(error.message),$("#lbl_signupError").removeClass("clear"),app.l(JSON.stringify(error,null,2),2),setTimeout(function(){$("#lbl_signupError").addClass("clear")},5e3)}})}},start:{init:function(){pages.start.getData().done(function(){pages.start.render().done(function(){pages.start.remE().then(pages.start.addE).then(app.remE().then(app.addE))})}),pages.events.getData().done(function(){pages.events.render()})},addE:function(){return $.Deferred(function(a){$("#santaList li").hammer().on("tap",function(e){app.meta.currentPersonObjectID=$(this).attr("id"),pages.personWishList.getData(app.showScreen($("section#personWishList"),!1),function(){app.l("Failed to get person data",2)})}),a.resolve()}).promise()},remE:function(){return $.Deferred(function(r){$("#santaList li .front").hammer().off("tap"),r.resolve()}).promise()},render:function(){return app.l("Render santa list",1),$.Deferred(function(render){if(user.santaList.length>0)$(".screen#start #santaList").html(""),$.each(user.santaList,function(i,v){var template=_.template($("#tpl_start_listItem").html());$(".screen#start #santaList").append(template(v))});else{var emptyTpl=_.template($("#tpl_start_listItem_empty").html());$(".screen#start #santaList").html(emptyTpl({}))}render.resolve()}).promise()},getData:function(forceDataUpdate){return app.l("Getting santa list items...",1),$.Deferred(function(getData){if(forceDataUpdate||user.santaListUpdatedAt<=(new Date).subMinutes(15)){var Santas=Parse.Object.extend("Santas"),santaListQuery=new Parse.Query(Santas);santaListQuery.equalTo("santa",Parse.User.current()),santaListQuery.include("recipient"),santaListQuery.include("event"),santaListQuery.ascending("createdAt"),santaListQuery.find({success:function(r){user.santaList=r,user.santaListUpdatedAt=new Date,app.l("...got santa list items FROM PARSE",1),getData.resolve(user.santaList)},error:function(e){console.error(e),app.e("Poop! I has some trouble finding who you need to shop for! Try again in a few minutes, ok?"),getData.reject(e)}})}else app.l("...got santa list items FROM CACHE",1),getData.resolve(user.santaList)}).promise()}},wishList:{init:function(){pages.wishList.getData().done(function(){pages.wishList.render().done(function(){pages.wishList.remE().done(pages.wishList.addE)})})},addE:function(){return app.addE(),console.log("addE"),$.Deferred(function(a){$("nav#top #btn_addItem").hammer().on("tap",function(){modals.mdl_item_create.show()}),a.resolve()}).promise()},remE:function(){return app.remE(),console.log("remE"),$.Deferred(function(r){$("nav#top #btn_addItem").hammer().off("tap"),r.resolve()}).promise()},render:function(){return $.Deferred(function(render){if(app.l("Render wish list",1),$("#wishList.screen #wishList").html(""),user.wishList.length>0)_.each(user.wishList,function(o,i,a){var t=_.template($("#tpl_wishList_listItem").html()),d={objectId:o.get("objectId"),name:o.get("name"),description:o.get("description"),photoURL:o.get("photo").url()};$("#wishList.screen #wishList").append(t(d))});else{var t=_.template($("#tpl_wishList_listItem_empty").html());$("#wishList.screen #wishList").html(t({}))}render.resolve()}).promise()},getData:function(forceDataUpdate){app.l("Getting wish list items...",1),$("#wishList.screen #wishList").html("");var loaderTpl=_.template($("#tpl_loading").html());return $("#wishList.screen #wishList").append(loaderTpl({})),$.Deferred(function(getData){if(forceDataUpdate||user.wishListUpdatedAt<=(new Date).subMinutes(5)){var Item=Parse.Object.extend("Item"),wishListQuery=new Parse.Query(Item);wishListQuery.descending("rating"),wishListQuery.equalTo("owner",Parse.User.current()),wishListQuery.include("owner"),wishListQuery.find({success:function(results){user.wishList=results,user.wishListUpdatedAt=new Date,app.l("...got wish list items FROM PARSE",1),getData.resolve(user.wishList)},error:function(error){app.e("Darn it! I couldn't find your Wish List.  Gimmea sec, and try again."),app.l(JSON.stringify(error,null,2),2),getData.reject(error)}})}else app.l("...got wish list items FROM CACHE",1),getData.resolve(user.wishList)}).promise()}},events:{init:function(forceDataUpdate){pages.events.getData(forceDataUpdate).done(function(){pages.events.render()})},addE:function(){return $.Deferred(function(a){app.addE(),$("nav#top #btn_addEvent").hammer().on("tap",function(){modals.mdl_event_create.show()}),$("#events.screen tab-group tab").hammer().on("tap",function(){$("#events.screen tab-group tab").removeClass("active"),$(this).addClass("active"),pages.events.tabCheck()}),$("#events.screen #eventList li").hammer().on("tap",function(){var eID=$(this).data("id");$(this).addClass("loading"),app.l("Tapped Attendance ID: "+eID,1);var ParseAttendance=_.find(user.eventList,function(obj){return obj.get("event").id==eID});pages.eventDetail.init(ParseAttendance.get("event"))}),$("#events.screen #invitationList li").hammer().on("tap",function(){var eID=$(this).data("id");$(this).addClass("loading"),app.l("Tapped Attendance ID: "+eID,1);var ParseAttendance=_.find(user.eventList,function(obj){return obj.get("event").id==eID});pages.eventDetail.init(ParseAttendance.get("event"))}),a.resolve()}).promise()},remE:function(){return $.Deferred(function(r){app.remE(),$("nav#top #btn_addEvent").hammer().off("tap"),$("#events.screen tab-group tab").hammer().off("tap"),$("#events.screen #eventList li").hammer().off("tap"),$("#events.screen #invitationList li").hammer().off("tap"),r.resolve()}).promise()},tabCheck:function(){$("#events.screen .tab-target").addClass("hidden"),$("#events.screen tab-group tab").each(function(i,o){$(this).hasClass("active")&&$("#events.screen #"+$(this).data("for")+".tab-target").removeClass("hidden")})},render:function(){pages.events.tabCheck();var eventTpl=_.template($("#tpl_events_listItem").html()),eventEmptyTpl=_.template($("#tpl_events_listItem_empty").html()),invitationTpl=_.template($("#tpl_invitation_listItem").html()),invitationEmptyTpl=_.template($("#tpl_invitation_listItem_empty").html());$("#events.screen #eventList").html(""),$("#events.screen #invitationList").html(""),_.each(user.eventList,function(o,i,a){var object={id:o.get("event").id,date:o.get("event").get("eventAt"),title:o.get("event").get("title"),description:o.get("event").get("description"),spendLimit:o.get("event").get("spendLimit")};1==o.get("status")||2==o.get("status")?$("#events.screen #eventList").append(eventTpl(object)):99==o.get("status")&&$("#events.screen #invitationList").append(invitationTpl(object))}),0==$("#events.screen #eventList li.event").length&&$("#events.screen #eventList").html(eventEmptyTpl({})),0==$("#events.screen #invitationList li.invitation").length?($('#events.screen tab[data-for="invitationList"] badge').html(""),$('#events.screen tab[data-for="invitationList"] badge').addClass("hidden"),$("#events.screen #invitationList").html(invitationEmptyTpl({}))):($('#events.screen tab[data-for="invitationList"] badge').html($("#events.screen #invitationList li.invitation").length),$('#events.screen tab[data-for="invitationList"] badge').removeClass("hidden"),app.updateBadge($("nav.tabBar div.item.events"),$("#events.screen #invitationList li.invitation").length)),pages.events.remE().done(pages.events.addE)},getData:function(forceDataUpdate){return $.Deferred(function(gd){user.getEvents(forceDataUpdate).done(function(){gd.resolve()}).fail(function(error){gd.reject(error)})}).promise()}},eventDetail:{init:function(ParseEventObjectToLoad){var loadTime=new Date;app.l("Init detail for eventID: "+ParseEventObjectToLoad.id,1),"undefined"!=typeof ParseEventObjectToLoad&&pages.eventDetail.getAttendanceForEvent(ParseEventObjectToLoad).done(function(attendanceArray){var doneTime=new Date,interval=1e3-(doneTime-loadTime);ParseEventObjectToLoad.attendance=attendanceArray,setTimeout(function(){$("#eventDetail.screen li").removeClass("loading"),pages.eventDetail.tabCheck(),pages.eventDetail.render(ParseEventObjectToLoad),pages.eventDetail.renderAttendance(attendanceArray)},0>interval?0:interval)})},addE:function(eventObject){return $.Deferred(function(a){app.addE(),$("#eventDetail.screen form#eventDetail").on("submit",function(e){$(this).data("dirty",util.formIsDirty($(this))),e.preventDefault()}),$("#eventDetail.screen form#eventDetail input, #eventDetail.screen form#eventDetail textarea").on("propertychange change click keyup input paste",function(){$(this).data("original")!=$(this).val()&&$(this).data("dirty",!0)}),$("#eventDetail.screen tab-group tab").hammer().on("tap",function(){$("#eventDetail.screen tab-group tab").removeClass("active"),$(this).addClass("active"),pages.eventDetail.tabCheck()}),$("nav#top #btn_back_eventDetail").hammer().on("tap",function(){var dirty=util.formIsDirty($("#eventDetail.screen form#eventDetail"));dirty?navigator.notification.confirm("You've made some changes, it seems.",function(buttonIndex){switch(buttonIndex){case 1:pages.eventDetail.updateEvent(eventObject).done(function(){app.showScreen($("#events.screen"))});break;case 2:app.showScreen($("#events.screen"))}},"Save changes?",["Yes please!","No thanks."]):app.showScreen($("#events.screen"))}),a.resolve()}).promise()},remE:function(){return $.Deferred(function(r){app.remE(),$("#eventDetail.screen form#eventDetail").off("submit"),$("#eventDetail.screen form#eventDetail input, #eventDetail.screen form#eventDetail textarea").off("propertychange change click keyup input paste"),$("#eventDetail.screen tab-group tab").hammer().off("tap"),$("nav#top #btn_back_eventDetail").hammer().off("tap"),r.resolve()}).promise()},tabCheck:function(){$("#eventDetail.screen .tab-target").addClass("hidden"),$("#eventDetail.screen tab-group tab").each(function(i,o){$(this).hasClass("active")&&$("#eventDetail.screen #"+$(this).data("for")+".tab-target").removeClass("hidden")})},render:function(retrievedParseEventData){var isAdmin=!1,eventAdmins=[];_.each(retrievedParseEventData.attendance,function(o,i,a){2==o.get("status")&&eventAdmins.push(o),2==o.get("status")&&o.get("attendee").id==Parse.User.current().id&&(isAdmin=!0)});var obj={title:retrievedParseEventData.get("title"),date:retrievedParseEventData.get("eventAt"),dateString:util.formatDateForDTL(retrievedParseEventData.get("eventAt")),spendLimit:retrievedParseEventData.get("spendLimit"),description:retrievedParseEventData.get("description"),isEventAdmin:isAdmin},edFormTpl=_.template($("#tpl_eventDetail").html());$("#eventDetail.screen #detail.tab-target").html(edFormTpl(obj)),isAdmin?$("#eventDetail.screen #attendance form#sendInvitation").removeClass("hidden"):$("#eventDetail.screen #attendance form#sendInvitation").addClass("hidden"),pages.eventDetail.remE().then(pages.eventDetail.addE(retrievedParseEventData)),app.showScreen($("#eventDetail.screen"))},getAttendanceForEvent:function(ParseEvent){return app.l("Retreiving Attendance for eventID: "+ParseEvent.id,1),$.Deferred(function(getAttendanceForEvent){var Attendance=Parse.Object.extend("Attendance"),attendanceQuery=new Parse.Query(Attendance);attendanceQuery.equalTo("event",ParseEvent),attendanceQuery.include("attendee"),attendanceQuery.find({success:function(attendanceArray){getAttendanceForEvent.resolve(attendanceArray)},error:function(e){app.e("Wat?! I can't find anyone for that event.  But I'll keep looking, and you can try again in a bit, ok? Ok."),app.l(JSON.stringify(e),2),getAttendanceForEvent.reject(e)}})}).promise()},renderAttendance:function(attendanceArray){var attendeeTpl=_.template($("#tpl_eventDetail_attendanceItem").html()),attendeeEmptyTpl=_.template($("#tpl_eventDetail_attendanceItem_empty").html());$("#eventDetail.screen ul#attendanceGoing").html(attendeeEmptyTpl({})),$("#eventDetail.screen ul#attendanceNotGoing").html(attendeeEmptyTpl({})),$("#eventDetail.screen ul#attendanceUnknown").html(attendeeEmptyTpl({}));var aGoing=[],aNotGoing=[],aUnknown=[];$("#eventDetail.screen .attendanceGoing.count").html(aGoing.length),$("#eventDetail.screen .attendanceNotGoing.count").html(aNotGoing.length),$("#eventDetail.screen .attendanceUnknown.count").html(aUnknown.length),_.each(attendanceArray,function(o,i,a){1==o.get("status")||2==o.get("status")?aGoing.push(o):0==o.get("status")?aNotGoing.push(o):aUnknown.push(o)}),aGoing.length>0&&($("#eventDetail.screen ul#attendanceGoing").html(""),$("#eventDetail.screen .attendanceGoing.count").html(aGoing.length),_.each(aGoing,function(o,i,a){$("#eventDetail.screen ul#attendanceGoing").append(attendeeTpl({id:o.get("attendee").id,isOwner:2==o.get("status")?!0:!1,name:o.get("attendee").get("displayName"),email:o.get("attendee").get("email")}))})),aNotGoing.length>0&&($("#eventDetail.screen ul#attendanceNotGoing").html(""),$("#eventDetail.screen .attendanceNotGoing.count").html(aNotGoing.length),_.each(aNotGoing,function(o,i,a){$("#eventDetail.screen ul#attendanceNotGoing").append(attendeeTpl({id:o.get("attendee").id,isOwner:2==o.get("status")?!0:!1,name:o.get("attendee").get("name"),email:o.get("attendee").get("email")}))})),aUnknown.length>0&&($("#eventDetail.screen ul#attendanceUnknown").html(""),$("#eventDetail.screen .attendanceUnknown.count").html(aUnknown.length),_.each(aUnknown,function(o,i,a){$("#eventDetail.screen ul#attendanceUnknown").append(attendeeTpl({id:o.get("attendee").id,isOwner:2==o.get("status")?!0:!1,name:o.get("attendee").get("name"),email:o.get("attendee").get("email")}))}))},getData:function(ParseEventObjectToLoad){return app.l("Retreiving data for eventID: "+ParseEventObjectToLoad.id,1),$.Deferred(function(getData){var Event=Parse.Object.extend("Event"),eventDetailQuery=new Parse.Query(Event);eventDetailQuery.get(ParseEventObjectToLoad.id,{success:function(event){getData.resolve(event)},error:function(e){app.e("Wat?! I can't find that event.  But I'll keep looking, and you can try again in a bit, ok? Ok."),app.l(JSON.stringify(e),2),getData.reject(e)}})}).promise()},updateEvent:function(eventObject){return $.Deferred(function(ue){eventObject.set("title",$("#eventDetail.screen form#eventDetail #txt_title").val()),eventObject.set("eventAt",util.DTLToDate($("#eventDetail.screen form#eventDetail #txt_date").val())),eventObject.set("spendLimit",parseInt($("#eventDetail.screen form#eventDetail #txt_spendLimit").val())),eventObject.set("description",$("#eventDetail.screen form#eventDetail #txt_description").val()),eventObject.save({success:function(){app.l("Updated event "+eventObject.id,1),ue.resolve()},error:function(error){app.l(JSON.stringify(error),2),app.e("Wat!? I couldn't save your changes.  I R THA DUM."),ue.reject()}})}).promise()}},itemDetail:{init:function(){},addE:function(){},remE:function(){},render:function(){},getData:function(){}},personWishList:{init:function(){},addE:function(){},remE:function(){},render:function(){},getData:function(successCallback,failCallack){var url="js/person-"+app.meta.currentPersonObjectID+".json";$.getJSON(url,function(d){}).done(function(d){console.log(d),successCallback&&successCallback()}).fail(function(d){app.l(d,2),failCallack&&failCallack()}).always(function(){})}},settings:{init:function(){pages.settings.remE(),pages.settings.addE(),pages.settings.getData()},addE:function(){$("section#settings #btn_logout").hammer().on("tap",function(e){app.exit(),e.preventDefault()})},remE:function(){$("section#settings #btn_logout").hammer().off("tap")},render:function(){$("nav#top .right").html(user.parse.get("firstName")+"'s Settings");var av=null;user.parse.get("avatar")&&(av=user.parse.get("avatar").url());var upData={objectId:user.parse.get("objectId"),avatar:av,firstName:user.parse.get("firstName"),lastName:user.parse.get("lastName"),elfName:user.parse.get("username")},template=_.template($("#tpl_userProfile").html());
$("section#settings #userProfile").html(""),$("section#settings #userProfile").append(template(upData))},getData:function(successCallback,failCallack){Parse.User.current().fetch({success:function(user){pages.settings.render(),successCallback&&successCallback()},error:function(user,error){app.e("Ah nuts!\nWe couldn't get your profile data!\nWe're on it though, try again later. :)"),app.l(JSON.stringify(error,null,2),2),failCallack&&failCallack()}})}}},app={meta:{currentPersonObjectID:""},d:{s3:{key:"SEM3B276C4B7FC81D24558D608D8121DF6AA",secret:"YjQ1NTMzNDRmMTNmMzQyNzgyMjhlOWQ1ODVjMThlZGM",productURI:"https://api.semantics3.com/v1/products?q=",productTestURI:"https://api.semantics3.com/test/v1/products?q="},outpan:{key:"e4df75113dd952806a676e683515c618"},s:[],l:[]},init:function(){localStorage.sessionLog="",localStorage.logs&&(app.d.l=JSON.parse(localStorage.logs)),shake=new Shake({threshold:15}),shake.start(),$(window).on("shake",function(){var newElfName=util.generateElfName();navigator.notification.confirm("(tee hee)",function(buttonIndex){switch(buttonIndex){case 1:console.log(newElfName);break;case 2:cordova.plugins.clipboard.copy(newElfName)}},newElfName,["lol, ok cloze","copy"])}),app.bindEvents(),Parse.User.current()?app.signin():app.showScreen($("section.screen#login"),!0)},exit:function(){Parse.User.logOut(),user.parse=Parse.User.current(),localStorage.setItem("user",JSON.stringify(user)),location.reload(!0)},signin:function(){user.parse=Parse.User.current(),localStorage.setItem("user",JSON.stringify(user)),app.showScreen($("section#start"),!0)},showScreen:function(s,animateBoolean){switch(animateBoolean?$("section.screen:not(.hidden)").each(function(){$(this).addClass("animate300").addClass("clear"),$(this).one("webkitTransitionEnd",function(){$(this).addClass("hidden"),$(this).removeClass("animate300").removeClass("clear")})}):$("section.screen").each(function(){$(this).addClass("hidden").addClass("clear")}),s.data("title")?$("nav#top .right").html(s.data("title")):$("nav#top .right").html("Shh Santa!"),$("nav#top .left i").addClass("clear"),$("nav#top .left i").addClass("hidden"),s.data("nav-icon")&&($("nav#top .left i[id="+s.data("nav-icon")+"]").removeClass("hidden"),setTimeout(function(){$("nav#top .left i[id="+s.data("nav-icon")+"]").removeClass("clear")},10)),$("nav#tab .item img.off").each(function(i){$(this).removeClass("hidden")}),$("nav#tab .item img.on").each(function(i){$(this).addClass("hidden")}),$("nav#tab .item[data-screen="+s.attr("id")+"] img.off").addClass("hidden"),$("nav#tab .item[data-screen="+s.attr("id")+"] img.on").removeClass("hidden"),animateBoolean?(s.addClass("clear").removeClass("hidden").addClass("animate300"),setTimeout(function(){s.removeClass("clear")},10),s.one("webkitTransitionEnd",function(){s.removeClass("animate300")})):s.removeClass("clear").removeClass("hidden"),s.attr("id")){case"login":pages.login.init();break;case"start":pages.start.init();break;case"signup":pages.signup.init();break;case"events":pages.events.init();break;case"settings":pages.settings.init();break;case"wishList":pages.wishList.init();break;default:console.log(s.attr("id"))}1==s.data("nav")?$("nav#top").removeClass("hideTop"):$("nav#top").addClass("hideTop"),1==s.data("tabbar")?$("nav#tab").removeClass("hideBottom"):$("nav#tab").addClass("hideBottom")},s:function(message,type){var d=new Date;type||(type=0);var log={date:d.getTime(),msg:message,type:type};2==type?console.error(log.date+"("+log.type+"): "+log.msg):1==type?console.warn(log.date+"("+log.type+"): "+log.msg):console.log(log.date+"("+log.type+"): "+log.msg),app.d.s.push(log),localStorage.sessionLog=JSON.stringify(app.d.s)},l:function(message,type){var d=new Date;type||(type=0);var log={date:d.getTime(),msg:message,type:type};2==type?console.error(log.date+"("+log.type+"): "+log.msg):1==type?console.warn(log.date+"("+log.type+"): "+log.msg):console.log(log.date+"("+log.type+"): "+log.msg),app.d.l.push(log),localStorage.logs=JSON.stringify(app.d.l)},e:function(message){"undefined"==typeof message&&(message="Something went wrong - but we've got the best Elves on the job."),navigator.notification.alert(message,function(){},"What a lump 'o coal","Nuts.")},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1),app.remE(),app.addE()},addE:function(){return $.Deferred(function(a){$(".touchable").on("touchstart mousedown",function(){$(".touchable").removeClass("touched"),$(this).addClass("touched")}),$(".touchable").on("touchend touchcancel mouseup",function(){$(".touchable").removeClass("touched")}),$(".touchable").hammer().on("tap",function(e){e.preventDefault(),$(this).addClass()}),$(".shakeable").on("touchstart mousedown",function(){$(".shakeable").removeClass("shake"),$(this).addClass("shake")}),$(".shakeable").on("touchend touchcancel mouseup",function(){$(".shakeable").removeClass("shake")}),$("nav#tab .item").hammer().on("tap",function(e){var s=$("section.screen#"+$(this).data("screen"));app.showScreen(s,!1)}),a.resolve()}).promise()},remE:function(){return $.Deferred(function(r){$(".touchable").off("touchstart mousedown"),$(".touchable").off("touchend touchcancel mouseup"),$(".touchable").hammer().off("tap"),$(".shakeable").off("touchstart mousedown"),$(".shakeable").off("touchend touchcancel mouseup"),$("nav#tab .item").hammer().off("tap"),r.resolve()}).promise()},onDeviceReady:function(){app.s("deviceready")},updateBadge:function(tabBarObject,badgeInteger){0==badgeInteger?tabBarObject.removeAttr("data-badge"):tabBarObject.attr("data-badge",badgeInteger)}},user={parse:null,santaList:[],santaListUpdatedAt:new Date(2e3,1,1),eventList:[],eventListUpdatedAt:new Date(2e3,1,1),getEvents:function(forceDataUpdate){return app.l("Getting user's events and invitations...",1),$.Deferred(function(getEvents){if(forceDataUpdate||user.eventListUpdatedAt<=(new Date).subMinutes(15)){var Attendance=Parse.Object.extend("Attendance"),attendanceQuery=new Parse.Query(Attendance);attendanceQuery.equalTo("attendee",Parse.User.current()),attendanceQuery.include("event"),attendanceQuery.ascending("createdAt"),attendanceQuery.find({success:function(r){user.eventList=r,user.eventListUpdatedAt=new Date,app.l("...got user's events and invitations FROM PARSE",1),getEvents.resolve(user.eventList)},error:function(e){console.error(e),app.e("Wowsa! I can't find your events right now! Try again in a few minutes, ok?"),getEvents.reject(e)}})}else app.l("...got user's events and invitations FROM CACHE",1),getEvents.resolve(user.eventList)}).promise()},wishList:[],wishListUpdatedAt:new Date(2e3,1,1)},util={random:function(min,max){return Math.floor(Math.random()*(max-min))+min},elf:{firstNameSyllables:["mon","fay","shi","zag","blarg","resh","izen","chi","under","little","hill","donk","larp","jazz","ears","hat","tarp","zion","ity","mirf","mop","tree","pine","magic","mana","tree","sugar","candy","sock","gift","buddy","derp","woo","ear","pointy","kris","grumpy","happy","silly","dopy","wiley","funny","fuzzy"],lastNameSyllables:["malo","zak","aboo","wonk","derp","wood","brush","thrup","green","brown","seed","nut","son","kilt","shoe","ion","hole","butch","esis","ou","ash","wind","weak","magi","large","pro","bush","shrub","hill","top","bottom","thistle","leaf","mountain","cliff","isle","islay","pond","candy","cane","pit","hole","story","book","tool","cheer","funny","furry","fuzzy","silly"]},generateElfName:function(){for(var fn="",numSyllablesFN=util.random(2,4),i=0;numSyllablesFN>i;i++)fn+=util.elf.firstNameSyllables[util.random(0,util.elf.firstNameSyllables.length)];var fnFirstLetter=fn.substr(0,1).toUpperCase();fn=fn.slice(1),fn=fnFirstLetter+fn;for(var ln="",numSyllablesLN=util.random(1,4),i=0;numSyllablesLN>i;i++)ln+=util.elf.lastNameSyllables[util.random(0,util.elf.lastNameSyllables.length)];var lnFirstLetter=ln.substr(0,1).toUpperCase();return ln=ln.slice(1),ln=lnFirstLetter+ln,fn+" "+ln},shake:null,formatDate:function(date){return moment(date).format("dddd, MMM Do YYYY [at] h:mm A")},formatDateForDTL:function(date){var timezoneOffset=60*date.getTimezoneOffset()*1e3,localDate=new Date(date.getTime()-timezoneOffset);return localDate.toISOString().replace("Z","")},DTLToDate:function(ISODateStringFromDTL){return new Date(moment(ISODateStringFromDTL).local().valueOf())},formIsDirty:function(formObject){var isDirty=!1;return formObject.find("input").each(function(i,v){1==$(this).data("dirty")&&(isDirty=!0)}),formObject.find("textarea").each(function(i,v){1==$(this).data("dirty")&&(isDirty=!0)}),isDirty},getDataUPCold:function(upc){var oauth=OAuth({consumer:{"public":app.d.s3.key,secret:app.d.s3.secret},signature_method:"PLAINTEXT"}),request_data={url:app.d.s3.productTestURI,method:"GET",data:{upc:upc,fields:["name"]}};({"public":app.d.s3.key,secret:app.d.s3.secret});$.ajax({url:request_data.url,type:request_data.method,data:oauth.authorize(request_data)}).done(function(data){console.log("S3:\n"+data)})},getDataUPC:function(upc,successCallback,errorCallback){var url="http://www.outpan.com/api/get-product.php?barcode="+upc+"&apikey="+app.d.outpan.key;app.l("Product lookup for UPC:"+upc,1),$.getJSON(url,null).done(function(d){d.error?errorCallback&&errorCallback(d):successCallback&&successCallback(d)}).fail(function(e){errorCallback&&errorCallback(e)}).always(function(){app.l("Product lookup complete for UPC:"+upc,1)})},photo:{fromLibrary:function(){return $.Deferred(function(flf){console.log("From LIBRARY"),navigator.camera.getPicture(function(data){flf.resolve(data)},function(){flf.reject(e)},{quality:75,destinationType:0,sourceType:0,allowEdit:!0,encodingType:0,targetWidth:512,targetHeight:512,saveToPhotoAlbum:!1,cameraDirection:0})}).promise()},takeNew:function(){return $.Deferred(function(tnf){console.log("Take NEW"),navigator.camera.getPicture(function(data){tnf.resolve(data)},function(e){tnf.reject(e)},{quality:75,destinationType:0,sourceType:1,allowEdit:!0,encodingType:0,targetWidth:512,targetHeight:512,saveToPhotoAlbum:!0,cameraDirection:1})}).promise()}},convertImgToBase64:function(url,callback,outputFormat){var canvas=document.createElement("CANVAS"),ctx=canvas.getContext("2d"),img=new Image;img.crossOrigin="Anonymous",img.onload=function(){var dataURL;canvas.height=img.height,canvas.width=img.width,ctx.drawImage(img,0,0),dataURL=canvas.toDataURL(outputFormat),callback.call(this,dataURL),canvas=null},img.src=url}};